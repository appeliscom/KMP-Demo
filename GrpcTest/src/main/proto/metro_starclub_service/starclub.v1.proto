syntax = "proto3";

option go_package = "GoServerCore/proto-storage/generated/go/metro_starclub";

import "identity_service/common.proto";
import "appelis/uuid.proto";
import "appelis/language.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

package metro.starclub.v1;

// Service for handling mobile api for starclub calls.
// all cals are working only when there is active campaign
// Api is working only with tokens with logged user. Otherwise api will return TOKEN_INVALID.
service StarClub {
  // Active campaign per company status detail... point balance...
  rpc GetStatus(GetStatusRequest) returns(GetStatusResponse) {}
  // Get user and company from token, then returns CampaignRule if there is one.
  rpc GetCompanyCampaignRule(GetCompanyCampaignRuleRequest) returns (GetCompanyCampaignRuleResponse) {}

  rpc GetCampaignDescription(GetCampaignDescriptionRequest) returns (GetCampaignDescriptionResponse) {}

  rpc GetPointsSummary(GetPointsSummaryRequest) returns (GetPointsSummaryResponse) {}
  // Point Movements for invoices for active campaign.
  rpc GetPointMovements(GetPointMovementsRequest) returns(GetPointMovementsResponse) {}
  // Coupon of active campaign + per company calculation of apply flag + per user usage of coupon
  rpc GetCoupons(GetCouponsRequest) returns (GetCouponsResponse) {}
  // Get coupon by id. If coupon doesn't exists returns payload null.
  rpc GetCouponById(GetCouponByIdRequest) returns (GetCouponByIdResponse) {}
  // Rpc will be called after swiping in app.
  rpc ApplyCoupon(ApplyCouponRequest) returns (ApplyCouponResponse) {}
}

message GetCompanyCampaignRuleRequest {
  appelis.identity.common.v1.Token token = 1;
}

message GetCompanyCampaignRuleResponse {
  oneof payload{
    appelis.identity.common.v1.TokenError tokenErr = 1;
    CampaignRule rule = 2;
  }
}

message GetCampaignDescriptionRequest {
  appelis.identity.common.v1.Token token = 1;
  appelis.Language lang = 2;
}

message GetCampaignDescriptionResponse {
  oneof payload{
    appelis.identity.common.v1.TokenError tokenErr = 1;
    bytes data = 2;
  }
}

message GetPointsSummaryRequest {
  appelis.identity.common.v1.Token token = 1;
}

message PointsSummary {
  uint32 totalCollectedPoints = 1;
  uint32 spentPoints = 2;
}

message GetPointsSummaryResponse{
  oneof payload{
    appelis.identity.common.v1.TokenError tokenErr = 1;
    PointsSummary summary = 2;
  }
}

message ApplyCouponRequest {
  appelis.identity.common.v1.Token token = 1;
  appelis.UUID couponId = 2;
}

enum ApplyError {
  UNKNOWN = 0;
  INSUFFICIENT_POINTS = 1;
  USER_BLOCKED = 2;
}

message ApplyCouponResponse {
  oneof payload{
    appelis.identity.common.v1.TokenError tokenErr = 1;
    ApplyError applyErr = 2;
    // When user swipe usage with ean code will be returned.
    Usage usage = 3;
  }
}

message GetCouponByIdRequest {
  appelis.identity.common.v1.Token token = 1;
  appelis.UUID couponId = 2;
}

message GetCouponByIdResponse {
  oneof payload {
    appelis.identity.common.v1.TokenError tokenErr = 1;
    CompanyCoupon data = 2;
  }
}


message GetCouponsRequest {
  appelis.identity.common.v1.Token token = 1;
}
message GetCouponsResponse {
  oneof payload {
    appelis.identity.common.v1.TokenError tokenErr = 1;
    CompanyCouponArray data = 2;
  }
}

message CompanyCouponArray {
  repeated CompanyCoupon data = 1;
}

message CompanyCoupon {
  Coupon coupon = 1;
  // This is valid usage of user logged in token, can be null.
  Usage usage = 2;
}

message Usage {
  google.protobuf.Timestamp createdAt = 1;
  google.protobuf.Timestamp validUntil = 2;
  // Ean will be populated only when now < validUntil
  string ean = 3;
}

message Coupon {
  appelis.UUID id = 1;
  string name = 2;
  google.protobuf.StringValue pictureUrl = 3;
  Price standardPrice = 4;
  Price starclubPrice = 5;
  uint32 actionPercentage = 6;
  uint32 starPointPrice = 7;
  bytes description = 8;
  google.protobuf.Timestamp validTo = 9;
  ApplicationIdentifier application = 10;
}

enum ApplicationIdentifier {
  UNKNOWN_APPLICATION_IDENTIFIER = 0;
  VOUCHER = 1;
  ITEM_DISCOUNT = 2;
  VOUCHER_AND_ITEM_DISCOUNT = 3;
}

message Price {
  double value = 1;
  double valueTax = 2;
}

message GetPointMovementsRequest {
  appelis.identity.common.v1.Token token = 1;
}

message GetPointMovementsResponse {
  oneof payload {
    appelis.identity.common.v1.TokenError tokenErr = 1;
    PointMovementArray data = 2;
  }
}

message GetStatusRequest {
  appelis.identity.common.v1.Token token = 1;
}

message GetStatusResponse {

  enum StatusError {
    STATUS_UNKNOWN = 0;
    USER_BLOCKED = 1;
  }

  oneof payload{
    appelis.identity.common.v1.TokenError tokenErr = 1;
    StatusError statusErr = 3;
    CampaignStatus status = 2;
  }
}

message CampaignStatus {
  Campaign campaign = 1;
  // Balance can be null.
  CompanyBalance balance = 2;
}

message Campaign {
  appelis.UUID id = 1;
  CampaignRange range = 2;
  string pictureUrl = 3;
  repeated CampaignRule rules = 4;
  string fullRulesUrl = 5;
}

message CampaignRule {
  double invoiceAmount = 1;
  int32 clubPoints = 2;
  string description = 3;
}

message CampaignRange {
  google.protobuf.Timestamp start = 1;
  google.protobuf.Timestamp collectingStart = 4;
  google.protobuf.Timestamp collectingEnd = 2;
  google.protobuf.Timestamp end = 3;
}

message CompanyBalance {
  int64 companyId = 1;
  // Balance of starpoints...
  int32 actualBalance = 2;
  int32 movementsCount = 5;
  string companyName = 3;
  google.protobuf.Timestamp updatedAt = 4;
}

message PointMovementArray {
  repeated PointMovement data = 1;
}

message PointMovement {
  message CollectingData {
    int32 pointsCollected = 1;
    string invoiceId = 2;
    double invoiceAmount = 3;
    // Optional, because invoice have user optional.
    google.protobuf.Int64Value invoiceUser = 4;
  }

  message SpendingData {
    int32 pointsSpent = 1;
    appelis.UUID couponId = 2;
    string couponName = 3;
    int64 userId = 4;
  }

  message CorrectionData {
    int32 points = 1;
    string description = 2;
  }

  appelis.UUID id = 1;
  google.protobuf.Timestamp createdAt = 2;
  oneof data {
    CollectingData collect = 3;
    SpendingData spending = 4;
    CorrectionData correction = 5;
  }
}


